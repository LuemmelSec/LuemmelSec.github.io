---
layout: post
title: Pentest - everything SMTP
---

In this blog-post I am trying to demystify SMTP for myself.  
As you may have read in the other posts I will most likely try to reflect my knowledge or work on certain problems I face, where these blog-posts are aimed to help me.  

This time it´s all about SMTP in regards of attacks and countermeasures.  
I already needed to write several reports that had sorts of findings regarding SMTP, and no matter how much I read about it or talked to my colleagues, I was not able to get the whole thing.  

## SMTP introduction  

The **Simple Mail Transfer Protocol** is meant to **SEND** e-mails.  
There is no difference if your mailclient is sending stuff to the Mail-Server, the Mail-Server is sending stuff to the Mail-Gateway, the Gateway is sending to a relay and so on.  
And I guess that is where things get confusing from time to time.  
The communication by default is in plaintext. But nowadays you will most likely see Mail-Servers switching from plaintext to a secure channel with the help of **TLS**.  
A SMTP-Server is capable of acting as a client or a server, as it can send and receive e-mails at the same time.  
Some termes used alongside with **SMTP** are:  
**Mail User Agent (MUA)**: This is a (part of a) program connecting to a SMTP-Server in order to send an e-mail. Most likely this is your Outlook, Thunderbird, ...  
**Mail Transfer Agent (MTA)**: The transport service part of a program. They receive and transfer the e-mail. This might be an Exchange-Server, an internet facing gateway or whatever.  
The corresponding [RFC5321](https://tools.ietf.org/html/rfc5321#page-12) is only talking about these two.  
If you start asking the internet about **SMTP** you will also stumble upon **Mail Submission Agent (MSA)** and **Mail Delivery Agent (MDA)** and several others. These are also describing functions and make the process apear more precisely. A **MSA** is the part which receives the e-mail from the **MUA** and the **MDA** is the part that will hand over the e-mail to the final receiving **MUA**. Most likely all these functions will be found in one single product, which can take care of all these steps.  
So a workflow of an e-mail´s travel would look like so:  
MUA → MSA → MTA → … → MTA → MDA → MUA

## A sample configuration  

For the ease of the write-up let´s consider the following scenario of a companie´s mail setup:
As we live in a Microsoft environment we have Windows clients with Outlook acting as the **MUA**.  
We have an Exchange-Server which is just reachable from inside the network. It receives the user´s e-mails and forwards them if needed.  
There also is a internet facing DMZ in which a firewall resides that also acts as a mail-relay. So the Exchange-Server sends e-mails for foreign receipients to this relay.  
So by now the mail-flow will look like:
Outlook → Exchange → firewall → SMTP-Server of the receiving side

## Attacking SMTP-Servers - external pentest

Now to the interesting part. When you are on an external engagement and you find a device with an open SMTP-port you most likely found a system that takes care of incoming e-mails from the internet.  
What I do first is a manual connect to the server with the help of telnet and check if I can send spoofed e-mails:  
```powershell 
telnet mail.company.com 25
EHLO company.com
MAIL FROM: pentester@company.com  
RCPT TO: boss@company.com
DATA  
SUBJECT: Test spoofing mail
This is a spoofing test. 
.
```

First we open a connection to port 25 on the SMTP-Server.  
We introduce ourselfs as acting for the **company.com** domain.  
Specify the account who sends the e-mail **pentester@company.com**.  
Who is the e-mail for **boss@company.com**.  
Specify that we want to send some **DATA** with the e-mail.  
The **SUBJECT** of our e-mail is set.  
We fill the body with some text.  
Final terminator for the SMTP communication to show we are done and ready to send is the **<.>**.  

![broken]({{ site.baseurl }}/images/telnet.JPG "telnet")

At this stage the SMTP-Server might react differently from case to case.  
You might not even be able to connect to the server as it perform several checks that you fail to pass.  
Or you might be blocked when saying that you want to send from **XYZ@company.com** as you are not allowed to send from outside or a SPF-check is made (more on this later).
The server might also say: Nice buddy, thanks for the e-mail, I will transfer it.  
This is the point where I first thought: Damn they made a mistake. I was able to send an e-mail on their behalf.  
But mostly this is a wrong assumption. This also tells you that the (in this case) firewall accepted you request in the first instance. If it does other checks afterwards is out of sight for you.  

### User enumeration

This also belongs to the basic checks i do.  
There are at least three methods to try to enumerate users at this stage:  
VRFY  
EXPN  
RCPT TO  


