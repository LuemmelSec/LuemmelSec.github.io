---
layout: post
title: Pentest - everything SMTP
---

In this blog-post I am trying to demystify SMTP for myself.  
As you may have read in the other posts I will most likely try to reflect my knowledge or work on certain problems I face, where these blog-posts are aimed to help me.  

This time it´s all about SMTP in regards of attacks and countermeasures.  
I already needed to write several reports that had sorts of findings regarding SMTP, and no matter how much I read about it or talked to my colleagues, I was not able to get the whole thing.  

## SMTP introduction  

The **Simple Mail Transfer Protocol** is meant to **SEND** e-mails.  
There is no difference if your mailclient is sending stuff to the Mail-Server, the Mail-Server is sending stuff to the Mail-Gateway, the Gateway is sending to a relay and so on.  
And I guess that is where things get confusing from time to time.  
The communication by default is in plaintext. But nowadays you will most likely see Mail-Servers switching from plaintext to a secure channel with the help of **TLS**.  
A SMTP-Server is capable of acting as a client or a server, as it can send and receive e-mails at the same time.  
Some termes used alongside with **SMTP** are:  
  
**Mail User Agent (MUA)**: This is a (part of a) program connecting to a SMTP-Server in order to send an e-mail. Most likely this is your Outlook, Thunderbird, ...  
**Mail Transfer Agent (MTA)**: The transport service part of a program. They receive and transfer the e-mail. This might be an Exchange-Server, an internet facing gateway or whatever.  
  
The corresponding [RFC5321](https://tools.ietf.org/html/rfc5321#page-12) is only talking about these two.  
If you start asking the internet about **SMTP** you will also stumble upon **Mail Submission Agent (MSA)** and **Mail Delivery Agent (MDA)** and several others. These are also describing functions and make the process apear more precisely. A **MSA** is the part which receives the e-mail from the **MUA** and the **MDA** is the part that will hand over the e-mail to the final receiving **MUA**. Most likely all these functions will be found in one single product, which can take care of all these steps.  
So a workflow of an e-mail´s travel would look like so:  
MUA → MSA → MTA → … → MTA → MDA → MUA

## A sample configuration  

For the ease of the write-up let´s consider the following scenario of a companie´s mail setup:  
As we live in a Microsoft environment we have Windows clients with Outlook acting as the **MUA**.  
We have an Exchange-Server which is just reachable from inside the network. It receives the user´s e-mails and forwards them if needed.  
There also is an internet facing DMZ in which a firewall resides that also acts as a mail-relay. So the Exchange-Server sends e-mails for foreign receipients to this relay.  
So by now the mail-flow will look like:
Outlook → Exchange → firewall → SMTP-Server of the receiving side

## Attacking SMTP-Servers - mail spoofing

Now to the interesting part. When you are on an external engagement and you find a device with an open SMTP-port you most likely found a system that takes care of incoming e-mails from the internet as the first instance.  
What I do first is a manual connect to the server with the help of telnet and check if I can send spoofed e-mails:  

![broken]({{ site.baseurl }}/images/telnet.JPG "telnet")

First we open a connection to port 25 on the SMTP-Server.  
We introduce ourselfs as acting for the **company.com** domain.  
Specify the account who sends the e-mail **pentester@company.com**.  
Who is the e-mail for **boss@company.com**.  
Specify that we want to send some **DATA** with the e-mail.  
The **SUBJECT** of our e-mail is set.  
We fill the body with some text.  
Final terminator for the SMTP communication to show we are done and ready to send is the **<.>**.  

At this stage the SMTP-Server might react differently from case to case:

1. You might not even be able to connect to the server as it performs several checks that you fail to pass.  
2. Or you might get blocked when saying that you want to send from **XYZ@company.com** as you are not allowed to send from outside or a SPF-check is made (more on this later).  
3. The server might also say: *Nice buddy, thanks for the e-mail. I will transfer it.*  

When the latter happens, this is the point where I first thought: Damn they made a mistake. I was able to send an e-mail on their behalf.  
But mostly this is a wrong assumption. This only tells you that the (in this case) firewall accepted you request in the first instance. If it does other checks afterwards is out of sight for you. Normally the customer would tell me that the e-mail was trapped at the firewall or that is was flagged as somehow malicious inside their Outlook.   
This also is the point where we started discussing and came to the conclusion, that the customers need some sort of authentication. But how exactly and in what cases?  
Well, there are several scenarios that might happen here:  

**1. Someone connects to your SMTP-server and wants to send from an external domain to your domain.**  
This is the "normal" case that one would assume to happen on a daily basis.  
From a customers point of view we want to make sure to check (SPF,DKIM,DMARC) if the sending party is legit??? to do so. If all checks are passed, the mail can be forwarded to the Exchange.   

**2. Someone connects to your SMTP-server and wants to send from you domain to your domain.**  
I would consider this to be at least unusual, as no one inside your organisation will normally directly transfer their mails to the firewall.  
This is where authentication could come into play. Under normal circumstances Outlook will push your e-mail to the Exchange, and your Exchange will authenticate to the firewall in order to send e-mails to outside your organisation.  
If you reveive e-mails from outside, the sending IP and **MAIL FROM** will be from outside your domain.   
So if an external IP wants to send from your domain to your domain you should enforce authentication or otherwise reject the message.  

![broken]({{ site.baseurl }}/images/telnet2.png "telnet")

**3. Someone connects to your SMTP-server and wants to send from an external domain to an external domain.**  
This would be an open mail-relay and you don´t want that to happen, unless you like yourself to be put on all the blacklists out there.  
This scenario is a type of misconfiguration where everyone would be able to abuse your SMTP-server to send out their SPAM to others around the globe.  
What you want to make sure here is the following:  
Your SMTP-server should not accept and forward e-mails from non-local IP addresses to non-local mailboxes by an unauthenticated or unauthorized user.  

Generally spoken the following points will make your SMTP-server act in a secure manner:  

- allow e-mail from local IP addresses to local mailboxes
- allow e-mail from local IP addresses to non-local mailboxes
- allow e-mail from non-local IP addresses to local mailboxes
- allow e-mail from clients that are authenticated and authorized if none of the three above is true

Everything else should be rejected.  

## Attacking SMTP-Servers - user enumeration

The enumeration of users is the second point of attack you want to mitigate.  
Checking if users can be enumerated also belongs to the basic checks I perform.  
There are at least three methods / commands to try to enumerate users at this stage:  
  
**VRFY**: Used to verfiy if a certain user is known to the SMTP-Server  
**EXPN**: Used to reveal the actual e-mail-address of an alias  
**RCPT TO**: A needed command to specify to whom the e-mail should be send  
  
You can check if the commands are available with the **HELP** command (if available).  

![broken]({{ site.baseurl }}/images/telnet1.JPG "telnet")

