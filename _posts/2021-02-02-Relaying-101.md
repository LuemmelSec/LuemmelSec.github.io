---
layout: post
title: Relaying 101
---

Hello fellas, or as we say in Germany: "Hallo Freunde der fettfreien Leberwurst."  

In todays blog-post we´ll be talking about relaying attacks, or more precisely about NTLM relaying attacks.  
As you already know I am new to the pentest field and as such we´re not going to deep dive here, but instead I am trying to give you an overview of what, why and when, mixed with some practical examples in regards to relaying attacks. Wherever appicable I´ll give you links for further reading.  

There´s nothing new here, just a short overview of the different types of attacks. All the hard work has been done beforehand by awesome people like [Dirk-jan Mollema](https://twitter.com/_dirkjan), [Laurent Gaffie](https://g-laurent.blogspot.com), [byt3bl33der](https://twitter.com/byt3bl33d3r) and all the crazy people behind [impacket](https://github.com/SecureAuthCorp/impacket), [responder](https://github.com/lgandx/Responder), [mitm6](https://github.com/fox-it/mitm6) and [bettercap](https://github.com/bettercap/bettercap).

## Introduction  

On a recent on-site engagement I was finding my self in a very foreclosed environment, consisting of two seperate subnets with only very few clients, but a complete Windows Active Directory on each of them. As I let the vulnscanner off the leash, I tried to figure out additional attacking paths besides ports and services. Having a look around what was possible, I was lucky enough to find that NetBIOS / LLMNR and IPv6 where enabled.
That were two seperate findings that might open the game to ntlmrelay, responder and mitm6. Together with the customer I was able to draw several attack paths, that an intruder with access to the network would be able to abuse, in order to do some severe damage to their environment.    

That being said...  

<img src="/images/2021-02-02/timeforactionmeme.png">

## Basics  

So let´s start by going through some very basics.  

1. What is [NTLM](https://docs.microsoft.com/en-us/windows/win32/secauthn/microsoft-ntlm)?  
**NTL**an**M**anager is an authentication protocol, and it is the successor of the **L**an**Manager** protocol. It is most likely to be found in Windows environments and was superseeded by Kerberos since Windows 2000. However if Kerberos authentication is not supported or not available, Windows systems will fall back to NTLM.  
The protocal has several design flaws and vulnerabilities, which you can read about [here](https://en.wikipedia.org/wiki/NT_LAN_Manager#Weakness_and_Vulnerabilities) and [here](https://www.helpnetsecurity.com/2019/10/10/ntlm-vulnerabilities/), allowing for authentication relaying if specific options are missing or not set correctly.  

2. What is relaying?  
Simply spoken it´s playing **Man in the Middle**, intercepting an authentication request from let´s say a client who want´s to access a SMB share on server A, and redirecting it to server B, so we as attacker can access the files on server B on their behalf.  

3. How to become the MitM?  
There are several ways. One of them is by ARP poisoning the subnet you are in, making other systems think you are the target they want to reach. Another one is by putting yourself in as the IPv6 DNS server of the systems, and as such fetch all DNS requests from the clients redirecting them where you want to. The next one is by replying to [NetBIOS-NS](https://en.wikipedia.org/wiki/NetBIOS) or [LLMNR](https://en.wikipedia.org/wiki/Link-Local_Multicast_Name_Resolution) broadcasts, which might happen if e.g. someone misstypes an UNC-path in his explorer, DNS can´t resolve it and as such a NetBIOS-NS or LLMNR broadcast is sent (if enabled) in the subnet asking who has ```\\fuckimisstypedmypath```. [responder](https://github.com/lgandx/Responder-Windows) can listen for those requests and say "Hey buddy, I am ```\\fuckimisstypedmypath```, you can now proceed with authentication. Kerberos? Sorry mate. But you can use NTLM :)"  

## Attacks  

There are several possible attack paths, and I will go through some of them here. They can be mixed to some extend, so you can e.g. use mitm6 to have systems report to your attacker machine or bettercap. You can relay authentications over HTTP to LDAP or SMB. Other things are not working like SMB to LDAP if NTLMv2 is in play (see [here](https://github.com/SecureAuthCorp/impacket/pull/500)).  

There are also several features which can be used like creating new computer objects in AD when relaying to LDAP, dumping SAM when connecting to SMB, open a permanet connection with the socks option and so on and so forth. I will mix all the stuff and make use of these features accross the described scenarios - but feel free to use them according to your needs and adopt to the situations you are facing.  

### Simple fetch of hashes  

We´ll use responder in this case.  
First we need to edit the config of responder, which can be found under ```/usr/share/responder/Responder.conf```.  
We want to enable SMB and HTTP server, so we can answer related requests. Our config should look like this:  

```
; Servers to start
SQL = On
SMB = On 
RDP = On
Kerberos = On
FTP = On
POP = On
SMTP = On
IMAP = On
HTTP = On 
HTTPS = On
DNS = On
LDAP = On
```  

responder can be started like this: 

```responder -I eth2```
```-I``` is specifying our network interface to listen on  

Now when a user on the same subnet as the attacker is misstyping an SMB share e.g. ```\\deathstar```, the client will first ask the DNS-server if he knows where to find ```deathstar```. The DNS server will reply that he cannot find a record for ```deathstar``` and as a fallback (as long as not disabled), the client will send a NetBIOS or LLMNR request (depending on the OS see [here](https://www.crowe.com/cybersecurity-watch/netbios-llmnr-giving-away-credentials#:~:text=NetBIOS%20and%20LLMNR%20are%20protocols,host%20names%20on%20local%20networks.&text=NetBIOS%20is%20generally%20outdated%20and,DNS)%20server%20might%20not%20exist.)), which is a broadcast in his subnet asking everyone: *Who is deathstar?*  

<img src="/images/2021-02-02/itsmememe.png">

That´s where responder comes into play, by answering this broadcasts, telling the client that he is ```deathstar```.

<img src="/images/2021-02-02/deathstar.png">  

<img src="/images/2021-02-02/creds.png">  

The hash that we get is a NTLMv2 hash, which we can crack e.g. with hashcat with the ```-m 5600``` hashmode.  

The same can be done by answering browsers requests for a [wpad](https://en.wikipedia.org/wiki/Web_Proxy_Auto-Discovery_Protocol#:~:text=The%20Web%20Proxy%20Auto-Discovery,proxy%20for%20a%20specified%20URL.) file. If the clients are set to autodiscover the settings for the proxy (which is the default setting) then the client will start to evaluate the address for the proxy config (sth. like http://wpad.company.com/wpad.dat, http://wpad.com/wwpad.dat - just have a look at the wikipedia entry) in this order:  

1. DHCP  
2. DNS  
3. On Windows if DNS fails - NetBIOS or LLMNR   

So if 1 and 2 are not configured, we can step in like described before, answering requests for the proxy config via NetBIOS / LLMNR.  
A word of warning at this stage: Be aware that the client will afterwards route all his browser HTTP traffic to you attacker machine which might brake stuff on the network.  

```responder -I eth2 -w```
```-w``` will enable the wpad proxy answering such requests

<img src="/images/2021-02-02/httpfettfreieleberwurst.png">  

Which again will give us the NTLMv2 hash.  

But we can do better. With the -b switch of responder, we can force the browser to do a basic authentication, which will give us the plain text creds.  

<img src="/images/2021-02-02/httpfuckingtypo.png">  

### DNS Poisoning    

In modern Windows environments we have a lot of systems being capable of using IPv6 (all since Windows Vista). By default IPv6 is enabled, but no one is really using it in local networks. IPv6 is taking precedence over IPv4, so when we issue a system an IPv6 address let´s say via DHCP, it will first try to communicate over IPv6. Same is true for the DNS servers. If a system has an IPv4 and IPv6 entry for a DNS server, it will first contact the IPv6 one. The requests will be made whenever a machines restarts, a network cable is pluged in etc., so you may have a little patience during a real world engagement.  

This is where [mitm6](https://github.com/fox-it/mitm6) comes into play. It´s a tool designed to answer IPv6 DHCP broadcasts in its subnet, assigning the demanding clients an IPv6 addres in the link-local range and a DNS server. *Guess what: the DNS server is us.* If you want to know more head over to the offical [blog about mitm6](https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/).  

We start mitm6 with the folowing parameters:  
```mitm6 -d mcafeelab.local -i eth2 -hw Win10x64```  
```-d``` is the domainname that we filter our requets on - the attacked domain  
```-i``` is the interface we have mitm6 listen on for events  
```-hw``` is for host whitelist and will enable you to limit the attack to a specific target, minimizing the effect on the attacked network  

Bare in mind that assigning IPv6 adresses to DCs and Exchange servers might disrupt their functions. When you have them on your subnet as well, you might also want to give the blacklist options of mitm6 a go, as they enable you to exclude domains or FQDNs. If you and the customer agreed on also attacking these machines, mitm6 was designed to only supply very short lease times and TTLs, so that very close to when you stop the attack everything will come back to normal functioning. As far as I can tell (my colleagues confirmed this), there is no big disruption at all.  

<img src="/images/2021-02-02/mimt6start.png">  

Next fire up ntlmrelay:  
```python3 ntlmrelayx.py -ip 10.55.0.30 -wh evilwpad -t ldaps://10.55.0.1```  
```-ip``` is the interface you want the relay to run on  
```-wh``` is for WPAD host, speciying your wpad file to serve  
```-t``` is the target where you want to relay to. In this case I choose to simply query ldap for all the juicy info -> will produce a lot of files for computer, users, policies, groups and trust  

<img src="/images/2021-02-02/mitm6ntlmrelayldap.png">  

<img src="/images/2021-02-02/loot.png">  

There are several other scenarios for the ntlmrelay where you can e.g. directly add a new computer object(```--add-computer```) via ldaps to the AD either using this to run bloodhound queries against the AD or by directly granting it delegation rights (```--delegate-access```) and do a ressource based delegation attack: [Dirk´s blog](https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/).  

#### Adding a ressource  

Adding just a ressource to later have valid credentials for the AD

```python3 ntlmrelayx.py -ip 10.55.0.30 -wh evilwpad -t ldaps://10.55.0.1 --add-computer```

<img src="/images/2021-02-02/addingcomputertoad.png">  

#### Ressource based delegation attack  

**HINT:** In order to get the ```--delegate-access``` working correctly I had to do the following modifictaions to the ```targetsutils.py``` located under ```impacket/impacket/examples/ntlmrelayx/utils```:  

Comment out line 136 and change 141 from .pop() to \[0\] - also see [issue914](https://github.com/SecureAuthCorp/impacket/issues/914):  

```python
136            #            self.generalCandidates.remove(target)
137                        return target
138                LOG.debug("No more targets for user %s" % identity)
139               return None
140            else:
141                return self.generalCandidates[0]

```
Now we can run our attack:  

```python3 ntlmrelayx.py -wh evilwpad -t ldaps://dc2016-2.mcafeelab.local --delegate-access```  

<img src="/images/2021-02-02/ressourcedelegation.png">  

```
getST.py -spn cifs/WIN10X64.mcafeelab.local mcafeelab.local/GCTCRVBY\$ -impersonate administrator  
export KRB5CCNAME=administrator.ccache  
secretsdump.py -k -no-pass win10x64.mcafeelab.local  
```  

<img src="/images/2021-02-02/ressourcedelegation2.png">  

Feel free to play around with the different scenarios.  

### ARP Spoofing  

Another way to have systems contact our attacker machine is by spoofing their ARP cache.  

And for fucks sake I was able to spoof all entries in the ARP table of the victim, even ICMP was targeting the attacker machine as expected, but not even one single request for SMB, HTTP or sth else did go through my kali box. They all normally reached their desired target, bypassing the attacker somehow. Tried 4 different clients in my virtual environment, even pwnd my "normal" physical home network with my physical devices. Tried bettercap and ettercap to no evail. Turned off every signing option for communication I found. 

I am sorry guys, but nothing to see here :(  

<img src="/images/2021-02-02/losermeme.png">  

### MS-RPRN Printer Bug  

Yes, there he is, the infamous printer bug found and abused by [Lee Christensen](https://twitter.com/tifkin_).   
It will allow you (if the spool service is running which is default) to have the computer-account authenticate to your attacker system. Normally this is to be seen in combination with unconstrained delegation attacks, but it will also serve the purpose of just relaying e.g to SMB on another system. It is not uncommon, that computer-accounts are local admins to other systems, which would give you full access to these systems.  
So let´s jump in.  

If you want to check if a system is vulnerable to this attack you can use the scanner from [vletoux](https://raw.githubusercontent.com/vletoux/SpoolerScanner/master/SpoolerScan.ps1) or use the implemented function from [S3cur3Th1sSh1t´s WinPwn](https://github.com/S3cur3Th1sSh1t/WinPwn).   

The code for the SpoolSample can be found [here](https://github.com/leechristensen/SpoolSample).  

We fire up ntlmrelay again:  
```python3 ntlmrelayx.py -t smb://10.55.0.100 -smb2support -socks```
```-t``` again is our target, in this case a workstation which we want to relay to as an SMB session  
```-smb2support``` well yes it enables smb2support *who would have thought it*  
```-socks``` is a cool feature which will get you away from the one shot scenarios and keep the session(s) alive, so you can interact with it at any given time -> more on this [here](https://www.secureauth.com/blog/playing-with-relayed-credentials/).  

<img src="/images/2021-02-02/ntlmrelaysocks.png">  

Next we need to be in domain context, so you either are on a domain joined system or you have creds and do a runas /netonly from powershell.  

<img src="/images/2021-02-02/spoolsample.png">  

<img src="/images/2021-02-02/houstonmeme.png">  

You can list all active connections with the ```socks``` cmdlet.  

<img src="/images/2021-02-02/socksconnect.png">  

And as you can already see, the computer-account of the DC is also admin on the client Win10X64 / 10.55.0.100.  

So what next? 

<img src="/images/2021-02-02/proxychainsmeme.png">  

Have ```/etc/proxychains4.conf```use a socks4 on your attacker machine:  

<img src="/images/2021-02-02/proxychainsconf.png">  

And route your tool of choice through the proxy. The password can be empty as the socks part of ntlmrelay will take care of the authentication, as long as you exactly use the notation from the ```socks``` output!!!  

The socks game can be improved further as can be read [here](https://www.secureauth.com/blog/what-is-old-is-new-again-the-relay-attack/). The tool makes it possible to specify multiple targets to which it will relay an incoming authentication by making use of the SMB status ```STATUS_NETWORK_SESSION_EXPIRED```, which will force the client to reauthenticate and as such allowing us to relay to as many devices as we like. The targets can either be plain IPs or DNS-names, or we can directly specify the protocol like LDAPS://10.55.0.1 or SMB://10.55.0.50. It is even possible to specify the user, so that we don´t relay all incoming connections like so: LDAP://MCAFEELAB\Administrator@10.55.0.2.

Define targets:  

<img src="/images/2021-02-02/targets.png">  

Start ntlmrelay:  

```ntlmrelayx.py -tf targets.txt -smb2support -socks```

See them connections rolling in:  

<img src="/images/2021-02-02/socksmany.png">  

You can now proceed as decribed above.  

#### smbclient  

```proxychains smbclient.py MCAFEELAB/DC2016-2\$@10.55.0.100```  

Jepp you are right, special characters like ```$``` need to be properly escaped with a ```\```.  

<img src="/images/2021-02-02/smbclient.png">  

#### secretsdump.py  

```proxychains secretsdump.py MCAFEELAB/DC2016-2\$@10.55.0.100```  

<img src="/images/2021-02-02/secretsdumppy.png">  

You get the point here...

### Zero Logon

Yeah that is still a problem, although the more recent systems are about to get a forced update to fix this this month. My personal oppinion is that we will see this for longer on internal pentests.  

However Dirk-jan did an outstanding job when he came up with an attack vector for this vulnerability which didn´t rely on resetting or zeroing the DC´s computer account password -> read [here](https://dirkjanm.io/a-different-way-of-abusing-zerologon/).   

We can again use ntlmrelay to carry out the attack. All we need to have is:  
1. 2 DCs  
2. One DC vulnerable to Zerologon the other one to the printer bug  

Check if DCs are vulnerable with [this](https://github.com/BC-SECURITY/Invoke-ZeroLogon):  

<img src="/images/2021-02-02/checkzerologon.png">  

Now we can fire up ntlmrelay with the ```DCSYNC``` option:  

```ntlmrelayx.py -t DCSYNC://10.55.0.1 -smb2support```  

And trigger the printer bug on the other DC:  

```.\SpoolSample_v4.5_x64..exe dc2016-2.mcafeelab.local 10.55.0.30```  

<img src="/images/2021-02-02/jokermeme.png">  

Dom-Admin hash which we can use together with mimikatz to do a dcsync or all the other dirty things.  

<img src="/images/2021-02-02/zeropwn.png">  

## Mitigations 

<img src="/images/2021-02-02/mitigatememe.png">  

These attacks have lots of aspects.  
Disable NetBIOS on all clients that don´t need it.    
Disable LLMNR on all clients that don´t need it.  
Enable SMB signing for your whole environment if possible.  
Enforce LDAP signing and channel binding.  
Disable the printer spool service where it´s not needed - *No, your DCs don´t fucking need it!*
Disable IPv6 on all devices that don´t need it or at least block DHCPv6 and router advertisement traffic with you client-firewall (Windows firewall will work with GPOs).  
If not in use: Disable WPAD via GPO. If in use: manually specify the path to your WPAD config - no autoconfig please. To further harden againt WPAD attacks you can disable the ```WinHttpAutoProxySvc``` service -> see [here](https://googleprojectzero.blogspot.com/2017/12/apacolypse-now-exploiting-windows-10-in_18.html)  
Patch your systems regularly - *No, twice a year is bullshit!*

Enable smb signing: [https://www.rootusers.com/configure-smb-signing-via-group-policy/](https://www.rootusers.com/configure-smb-signing-via-group-policy/)   
Disable llmnr: [https://www.blackhillsinfosec.com/how-to-disable-llmnr-why-you-want-to/](https://www.blackhillsinfosec.com/how-to-disable-llmnr-why-you-want-to/)    
Disable NetBIOS: [http://woshub.com/how-to-disable-netbios-over-tcpip-and-llmnr-using-gpo/](http://woshub.com/how-to-disable-netbios-over-tcpip-and-llmnr-using-gpo/)   
LDAP channel binding: [https://support.microsoft.com/en-us/topic/use-the-ldapenforcechannelbinding-registry-entry-to-make-ldap-authentication-over-ssl-tls-more-secure-e9ecfa27-5e57-8519-6ba3-d2c06b21812e](https://support.microsoft.com/en-us/topic/use-the-ldapenforcechannelbinding-registry-entry-to-make-ldap-authentication-over-ssl-tls-more-secure-e9ecfa27-5e57-8519-6ba3-d2c06b21812e)  

## Conclusion  



## Ressources  

Below you´ll find all the ressources that helped me understanding and aided as a guidline to this blog-post:  

[https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)  
[https://dirkjanm.io/exploiting-CVE-2019-1040-relay-vulnerabilities-for-rce-and-domain-admin/](https://dirkjanm.io/exploiting-CVE-2019-1040-relay-vulnerabilities-for-rce-and-domain-admin/)  
[https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/](https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/)  
[https://dirkjanm.io/krbrelayx-unconstrained-delegation-abuse-toolkit/](https://dirkjanm.io/krbrelayx-unconstrained-delegation-abuse-toolkit/)  
[https://hackernoon.com/man-in-the-middle-attack-using-bettercap-framework-hd783wzy](https://hackernoon.com/man-in-the-middle-attack-using-bettercap-framework-hd783wzy)  
[https://blog.fox-it.com/2017/05/09/relaying-credentials-everywhere-with-ntlmrelayx/](https://blog.fox-it.com/2017/05/09/relaying-credentials-everywhere-with-ntlmrelayx/)  
[https://en.hackndo.com/ntlm-relay/](https://en.hackndo.com/ntlm-relay/)  
[https://trelis24.github.io/2018/08/03/Windows-WPAD-Poisoning-Responder/](https://trelis24.github.io/2018/08/03/Windows-WPAD-Poisoning-Responder/)  
[https://blog.compass-security.com/2020/05/relaying-ntlm-authentication-over-rpc/](https://blog.compass-security.com/2020/05/relaying-ntlm-authentication-over-rpc/)  
[https://attack.mitre.org/techniques/T1557/001/](https://attack.mitre.org/techniques/T1557/001/)  
[https://attack.mitre.org/techniques/T1557/002/](https://attack.mitre.org/techniques/T1557/002/)  